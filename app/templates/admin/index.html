{% extends "app/layout.html" %}
{% load crispy_forms_tags %}

{% block content %}
{% if user.is_superuser %}
<h1 class="page-header">
	Dashboard
</h1>
<div id="admin_alerts">
	<!--if there are any alerts, add them dynamically with js-->
</div>
<div class="col-md-6 col-xs-12">
	<div class="panel panel-primary">
		<div class="panel panel-heading">
			<div id="float-left">
				Class Confidence
			</div>
			<div id="float-text-right">
				<button class="btn btn-default" onclick="minimize_panel('confidence-meter-panel', 'confidence-meter-btn');">
	                    <span id="confidence-meter-btn" class="glyphicon glyphicon-chevron-up"></span>
	            </button>
			</div>
		</div>
		<div class="panel panel-body" id="confidence-meter-panel">
			<div id="confidence-graph" style="width:100%;height:300px"></div>
		</div>
	</div>

	<div class="panel panel-primary">
		<div class="panel panel-heading">
			<div id="float-left">
				Quick Create Quiz
			</div>
			<div id="float-text-right">
				<button class="btn btn-default" onclick="minimize_panel('quick-quiz-panel', 'quick-quiz-btn');">
	                    <span id="quick-quiz-btn" class="glyphicon glyphicon-chevron-up"></span>
	            </button>
			</div>
		</div>
		<div class="panel panel-body" id="quick-quiz-panel">
			<form method="post">
				<input type="hidden" name="csrfmiddlewaretoken" value='{{csrf_token}}'>
				{{ quick_quiz_form|crispy }}
				{{ quick_quiz_inline_form|crispy }}
				<div class="form_actions">
					<input type="submit" name="quiz" value="Submit" class="btn btn-primary" id="submit-id-wordcloud">
				</div>
			</form>
		</div>
	</div>

	<div class="panel panel-primary">
		<div class="panel panel-heading">
			<div id="float-left">
				Quick Create Wordcloud
			</div>
			<div id="float-text-right">
				<button class="btn btn-default" onclick="minimize_panel('quick-wordcloud-panel', 'quick-wordcloud-btn');">
	                    <span id="quick-wordcloud-btn" class="glyphicon glyphicon-chevron-up"></span>
	            </button>
			</div>
		</div>
		<div class="panel panel-body" id="quick-wordcloud-panel">
			{% crispy quick_wordcloud_form %}
		</div>
	</div>

</div>
<div class="col-md-6 col-xs-12">
	<div class="panel panel-primary">
		<div class="panel panel-heading">
			<div id="float-left">
				Quick Settings
			</div>
			<div id="float-text-right">
				<button class="btn btn-default" onclick="minimize_panel('quick-settings-panel', 'quick-settings-btn');">
	                    <span id="quick-settings-btn" class="glyphicon glyphicon-chevron-up"></span>
	            </button>
			</div>
		</div>
		<div class="panel panel-body" id="quick-settings-panel">
			{% crispy quick_settings_form %}
		</div>
	</div>

	<div class="panel panel-primary">
		<div class="panel panel-heading">
			<div id="float-left">
				Quiz Results Summaries
			</div>
			<div id="float-text-right">
				<button class="btn btn-default" onclick="minimize_panel('quiz-results-panel', 'quiz-results-btn');">
	                    <span id="quiz-results-btn" class="glyphicon glyphicon-chevron-up"></span>
	            </button>
			</div>
		</div>
		<div class="panel panel-body" id="quiz-results-panel">
			{% for quiz in recent_quizzes %}
				<table class="table">
				{% for question, choices in quiz.items %}
					<thead>
						<tr>{{question}}</tr>
					</thead>
					<tbody>
						<tr>
						{% for choice in choices %}
							<td>{{choice}}</td>
						{% endfor %}
						</tr>
					</tbody>
				{% endfor %}
				</table>
			{% endfor %}
		</div>

	</div>

	<div class="panel panel-primary">
		<div class="panel panel-heading">
			<div id="float-left">
				Quick Create Code Snippet
			</div>
			<div id="float-text-right">
				<button class="btn btn-default" onclick="minimize_panel('quick-code-panel', 'quick-code-btn');">
	                    <span id="quick-code-btn" class="glyphicon glyphicon-chevron-up"></span>
	            </button>
			</div>
		</div>
		<div class="panel panel-body" id="quick-code-panel">
			{% crispy quick_codesnippet_form %}
		</div>
	</div>

</div>

{% endif %}

{% endblock %}

{% block scripts %}

<script type="text/javascript">




	function plot_confidence(data) {
	    flot_data = []
	    Object.keys(data).forEach(function (key) {
	    	var value = data[key]
	    	color = ''
	    	/* place in each if statement to prevent key 'current' from being in the graph */
	    	if (key=='good') {
	    		color="#5cb85c"
	    		flot_data.push({label: key, data: value, color: color})
	    	}
	    	if (key=='neutral') {
	    		color="#f0ad4e"
	    		flot_data.push({label: key, data: value, color: color})
	    	}
	    	if (key=='bad') {
	    		color="#d9534f"
	    		flot_data.push({label: key, data: value, color: color})
	    	}
	    });
		$.plot('#confidence-graph', flot_data, {
	    series: {
	        pie: {
	            show: true
	        	}
	    	}
	    });
	}
	
	var ping_interval = 1000*15
    setInterval(function() {
        $.ajax({
	        type: "GET",
	        url:  "/poll/",
	        dataType: 'json',
	        success: function (data) {
	        	plot_confidence(data)
	        },
	        error: function(response){
	        },
    	});
        }, ping_interval
    )

    function quick_update(data_id, value) {
    	data = {
    		'csrfmiddlewaretoken': '{{csrf_token}}',
    		'quick_settings': 'Submit',
    	}
    	data[data_id] = value
    	$.ajax({
		        type: "POST",
		        url:  "/quick_update/",
		        dataType: 'json',
		        data: data,
		        success: function (data) {
		        	if (data.return_type == 'lecture') {
		        		$('#id_Lecture').attr("value", data.return_value);	
		        	}
		        	if (data.return_type == 'quiz') {
		        		$("#quick_quiz_select option[value='" + data.return_value + "']").remove();
		        	}
		        	if (data.return_type == 'wordcloud') {
		        		$("#quick_wordcloud_select option[value='" + data.return_value + "']").remove();
		        	}
		        	if (typeof data.notice !== 'undefined') {
		        		close_button = 	'<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
										'<span aria-hidden="true">&times;</span>' +
										'</button>'
		        		$("#admin_alerts").html('<div class="alert alert-success alert-dismissable" role="alert">' + data.notice + close_button + '</div>')
		        	}
		        },
		        error: function(response){
		        },
    		});
    }

    function addQuickSelectHandlers() {
		$("#quick_lecture_select").change(function(data) {
			quick_update('lecture', this.options[this.selectedIndex].value)
		});
		$("#quick_quiz_select").change(function(data) {
			quick_update('quiz', this.options[this.selectedIndex].value)
		});
		$("#quick_wordcloud_select").change(function(data) {
			quick_update('wordcloud', this.options[this.selectedIndex].value)
		});

	}

	$(document).ready(addQuickSelectHandlers);
</script>
{% endblock %}

{% block sidebar %}
    {% include "admin/sidebar.html" %}
{% endblock %}
